<div class="row">
  <div class="col-md-12">
    <h3>統計情報ベータ版</h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th rowspan="3">月</th>
          <th colspan="3">会員数</th>
          <th colspan="<%= @schools.count * 4 %>">受講クラス数</th>
        </tr>
        <tr>
          <th rowspan="2">入会</th>
          <th rowspan="2">継続</th>
          <th rowspan="2">退会</th>
          <% @schools.each do |school| %>
            <th colspan="4"><%= school.name %></th>
          <% end %>
        </tr>
        <tr>
          <% @schools.each do |school| %>
            <th>入会</th>
            <th>継続</th>
            <th>退会</th>
            <th>休会</th>
          <% end %>
        </tr>
      </thead>
      <tbody>
        <% @months.each do |month| %>
          <tr>
            <!-- 会員数 -->
            <% active = Member.active(month).count %>
            <% registered = Member.registered(month).count %>
            <% canceled = Member.canceled(month).count %>
            <td><%= "#{month[0,4]}年#{month[4,5]}月" %></td>
            <td>
              <div class="pull-right">
                <%= link_to_if registered > 0, registered, statistics_members_path(month: month, status: "registered") %>
              </div>
            </td>
            <td>
              <div class="pull-right">
                <% active = active - registered - canceled %>
                <%# link_to((active - registered - canceled), statistics_members_path(month: month, status: "active")) %>
                <%= link_to_if active > 0, active, statistics_members_path(month: month, status: "active") %>
              </div>
            </td>
            <td>
              <div class="pull-right">
                <%= link_to_if canceled > 0, canceled, statistics_members_path(month: month, status: "canceled") %>
              </div>
            </td>
            <!-- 受講クラス -->
            <% @schools.each do |school| %>
              <% if school.open_date.strftime("%Y%m") <= month %>
                <% end_of_month = (month + "01").to_date.end_of_month %>
                <% active = MembersCourse.active(end_of_month).joins(course: [timetable: [studio: :school]]).where(schools: { id: school.id }).count %>
                <% registered = MembersCourse.registered(month).joins(course: [timetable: [studio: :school]]).where(schools: { id: school.id }).count %>
                <% canceled = MembersCourse.canceled(month).joins(course: [timetable: [studio: :school]]).where(schools: { id: school.id }).count %>
                <% registered_and_canceled = MembersCourse.registered_and_canceled(month).joins(course: [timetable: [studio: :school]]).where(schools: { id: school.id }).count %>
                <% recessed = Recess.where(month: month).joins(members_course: [course: [timetable: [studio: :school]]]).merge(MembersCourse.active(end_of_month)).where(schools: { id: school.id }).count %>
                <td>
                  <div class="pull-right">
                    <%= link_to_if registered > 0, registered, statistics_members_courses_path(month: month, school_id: school.id, status: "registered") %>
                  </div>
                </td>
                <td>
                  <div class="pull-right"><%= active - (registered - registered_and_canceled) - canceled %></div>
                </td>
                <td>
                  <div class="pull-right">
                    <%= link_to_if canceled > 0, canceled, statistics_members_courses_path(month: month, school_id: school.id, status: "canceled") %>
                  </div>
                </td>
                <td>
                  <div class="pull-right">
                    <%= link_to_if recessed > 0, recessed, statistics_recesses_path(month: month, school_id: school.id, status: "recessed") %>
                  </div>
                </td>
              <% else %>
                <td></td><td></td><td></td><td></td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
